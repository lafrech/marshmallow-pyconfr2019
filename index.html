<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Jérôme Lafréchoux">
  <title>Marshmallow De la sérialization à la construction d’une API REST</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/reveal.css">
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/theme/black.css" id="theme">
  <link rel="stylesheet" href="custom.css"/>
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/print/pdf.css' : 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/lib/js/html5shiv.js"></script>
  <![endif]-->
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">Marshmallow<br />
De la sérialization<br />
à la construction d’une API REST</h1>
  <p class="author">Jérôme Lafréchoux</p>
  <p class="date">PyConFR - 3 novembre 2019</p>
</section>

<section id="sommaire" class="slide level2">
<h2>Sommaire</h2>
<ul>
<li>La sérialisation</li>
<li>marshmallow</li>
<li>L’écosystème marshmallow</li>
<li>Construction d’une API REST: flask-smorest</li>
</ul>
</section>
<section><section id="la-sérialisation" class="title-slide slide level1"><h1>La sérialisation</h1></section><section id="cest-quoi" class="slide level2">
<h2>C’est quoi?</h2>
<ul>
<li>Codage d’objets Python sous une forme adaptée pour
<ul>
<li>Sauvegarde</li>
<li>Transport</li>
</ul></li>
<li><p>Processus réversible (désérialisation)</p></li>
<li>Utilisations typiques
<ul>
<li>Format d’échange (ex: service web)</li>
<li>Fichier de configuration</li>
<li>Sauvegarde de résultats de calcul</li>
<li>Stockage temporaire sur disque</li>
<li>…</li>
</ul></li>
</ul>
</section><section id="pickle" class="slide level2">
<h2>Pickle</h2>
<p>Objet → <em>Byte stream</em> → Objet</p>
<ul>
<li>Avantages
<ul>
<li>Bibliothèque standard</li>
<li>Rapide</li>
</ul></li>
<li>Inconvénients
<ul>
<li>Compatibilité : désérialisation nécessite Python</li>
<li>Sécurité : injection de code</li>
</ul></li>
</ul>
</section><section id="json-1" class="slide level2">
<h2>json (1)</h2>
<p>Objet → JSON → Objet</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb1-1" title="1"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb1-2" title="2"></a>
<a class="sourceLine" id="cb1-3" title="3">user <span class="op">=</span> {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Roger&quot;</span>}</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5">json.dumps(user)</a>
<a class="sourceLine" id="cb1-6" title="6"><span class="co"># &#39;{&quot;name&quot;: &quot;Roger&quot;}&#39;</span></a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8">json.loads(<span class="st">&#39;{&quot;name&quot;: &quot;Roger&quot;}&#39;</span>)</a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co"># {&#39;name&#39;: &#39;Roger&#39;}</span></a></code></pre></div>
</section><section id="json-2" class="slide level2">
<h2>json (2)</h2>
<p>Mais JSON ne définit que des types basiques : <em>number</em>, <em>string</em>, <em>boolean</em>, <em>array</em>, <em>object</em>, <em>null</em>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb2-1" title="1"><span class="im">import</span> json</a>
<a class="sourceLine" id="cb2-2" title="2"><span class="im">import</span> datetime <span class="im">as</span> dt</a>
<a class="sourceLine" id="cb2-3" title="3"></a>
<a class="sourceLine" id="cb2-4" title="4">user <span class="op">=</span> {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Roger&quot;</span>, <span class="st">&quot;birth_date&quot;</span>: dt.datetime(<span class="dv">1983</span>, <span class="dv">1</span>, <span class="dv">23</span>)}</a>
<a class="sourceLine" id="cb2-5" title="5"></a>
<a class="sourceLine" id="cb2-6" title="6">json.dumps(user)</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="co"># TypeError: datetime.datetime(1983, 1, 23, 0, 0) is not JSON serializable</span></a></code></pre></div>
</section><section id="json-3" class="slide level2">
<h2>json (3)</h2>
<ul>
<li>Avantages
<ul>
<li>Standard / Inter-opérable</li>
<li>Lisible</li>
</ul></li>
<li>Inconvénients
<ul>
<li>Ne représente que quelques types Python de base</li>
</ul></li>
</ul>
</section><section id="bibliothèque-de-sérialisation-1" class="slide level2">
<h2>Bibliothèque de sérialisation (1)</h2>
<p>Transforme un objet Python en dictionnaire de types simples, <em>JSONisable</em></p>
<p>Objet → <em>dict</em> → Objet</p>
<p>Surcouche de json</p>
<p>Objet → <em>dict</em> → JSON → <em>dict</em> → Objet</p>
</section><section id="bibliothèque-de-sérialisation-2" class="slide level2">
<h2>Bibliothèque de sérialisation (2)</h2>
<ul>
<li>Avantages
<ul>
<li>Standard / Inter-opérable</li>
<li>Lisible</li>
<li>Pas limité aux types simples</li>
</ul></li>
<li>Inconvénients
<ul>
<li>Nécessite de définir la sérialisation des objets non standards</li>
<li>Bibliothèque non standard</li>
</ul></li>
</ul>
</section></section>
<section><section id="marshmallow" class="title-slide slide level1"><h1>marshmallow</h1></section><section id="fonctionnalités" class="slide level2">
<h2>Fonctionnalités</h2>
<ul>
<li>Sérialisation vers <em>dict</em> ou JSON</li>
<li>Désérialisation depuis <em>dict</em> ou JSON</li>
<li>Validation lors de la désérialisation</li>
</ul>
</section><section id="schémas-et-champs" class="slide level2">
<h2>Schémas et champs</h2>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb3-1" title="1"><span class="im">import</span> datetime <span class="im">as</span> dt</a>
<a class="sourceLine" id="cb3-2" title="2"><span class="im">import</span> marshmallow <span class="im">as</span> ma</a>
<a class="sourceLine" id="cb3-3" title="3"></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="kw">class</span> UserSchema(ma.Schema):</a>
<a class="sourceLine" id="cb3-5" title="5">    name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb3-6" title="6">    birth_date <span class="op">=</span> ma.fields.DateTime()</a>
<a class="sourceLine" id="cb3-7" title="7"></a>
<a class="sourceLine" id="cb3-8" title="8">schema <span class="op">=</span> UserSchema()</a>
<a class="sourceLine" id="cb3-9" title="9"></a>
<a class="sourceLine" id="cb3-10" title="10">user <span class="op">=</span> {<span class="st">&quot;name&quot;</span>: <span class="st">&quot;Roger&quot;</span>, <span class="st">&quot;birth_date&quot;</span>: dt.datetime(<span class="dv">1983</span>, <span class="dv">1</span>, <span class="dv">23</span>)}</a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12">schema.dump(user)</a>
<a class="sourceLine" id="cb3-13" title="13"><span class="co"># {&#39;name&#39;: &#39;Roger&#39;, &#39;birth_date&#39;: &#39;1983-01-23T00:00:00&#39;}</span></a>
<a class="sourceLine" id="cb3-14" title="14"></a>
<a class="sourceLine" id="cb3-15" title="15">schema.dumps(user)</a>
<a class="sourceLine" id="cb3-16" title="16"><span class="co"># &#39;{&quot;name&quot;: &quot;Roger&quot;, &quot;birth_date&quot;: &quot;1983-01-23T00:00:00&quot;}&#39;</span></a></code></pre></div>
</section><section id="séparation-modèle-vue-1" class="slide level2">
<h2>Séparation modèle / vue (1)</h2>
<p>Modèle</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb4-1" title="1"><span class="im">import</span> orm</a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="kw">class</span> Member(orm.Model):</a>
<a class="sourceLine" id="cb4-4" title="4">    first_name <span class="op">=</span> orm.StringField()</a>
<a class="sourceLine" id="cb4-5" title="5">    last_name <span class="op">=</span> orm.StringField()</a>
<a class="sourceLine" id="cb4-6" title="6">    birthdate <span class="op">=</span> orm.DateTimeField()</a>
<a class="sourceLine" id="cb4-7" title="7">    age <span class="op">=</span> orm.IntegerField()</a>
<a class="sourceLine" id="cb4-8" title="8">    password <span class="op">=</span> orm.StringField()</a>
<a class="sourceLine" id="cb4-9" title="9"></a>
<a class="sourceLine" id="cb4-10" title="10"><span class="kw">class</span> Team(orm.Model):</a>
<a class="sourceLine" id="cb4-11" title="11">    name <span class="op">=</span> orm.StringField()</a>
<a class="sourceLine" id="cb4-12" title="12">    creation_date <span class="op">=</span> orm.DateTimeField()</a>
<a class="sourceLine" id="cb4-13" title="13">    members <span class="op">=</span> orm.ManyToMany(Member)</a></code></pre></div>
</section><section id="séparation-modèle-vue-2" class="slide level2">
<h2>Séparation modèle / vue (2)</h2>
<p>Schémas</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb5-1" title="1"><span class="im">import</span> marshmallow <span class="im">as</span> ma</a>
<a class="sourceLine" id="cb5-2" title="2"></a>
<a class="sourceLine" id="cb5-3" title="3"><span class="kw">class</span> TeamSchema(ma.Schema):</a>
<a class="sourceLine" id="cb5-4" title="4">    name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb5-5" title="5">    creation_date <span class="op">=</span> ma.fields.DateTime()</a></code></pre></div>
<p>Ressources</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb6-1" title="1"><span class="im">from</span> .models <span class="im">import</span> Team</a>
<a class="sourceLine" id="cb6-2" title="2"><span class="im">from</span> .schemas <span class="im">import</span> TeamSchema</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4">team <span class="op">=</span> Team.get(name<span class="op">=</span><span class="st">&quot;Ghostbusters&quot;</span>)</a>
<a class="sourceLine" id="cb6-5" title="5"></a>
<a class="sourceLine" id="cb6-6" title="6">schema <span class="op">=</span> TeamSchema()</a>
<a class="sourceLine" id="cb6-7" title="7"></a>
<a class="sourceLine" id="cb6-8" title="8">schema.dump(team)</a>
<a class="sourceLine" id="cb6-9" title="9"><span class="co"># {&#39;name&#39;: &#39;Ghostbusters&#39;, &#39;creation_date&#39;: &#39;1983-01-23T00:00:00&#39;}</span></a></code></pre></div>
</section><section id="read-only-write-only" class="slide level2">
<h2>Read-only, Write-only</h2>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb7-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb7-2" title="2">    first_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb7-3" title="3">    last_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb7-4" title="4">    birthdate <span class="op">=</span> ma.fields.DateTime()</a>
<a class="sourceLine" id="cb7-5" title="5">    age <span class="op">=</span> ma.fields.Int(dump_only<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb7-6" title="6">    password <span class="op">=</span> ma.fields.Str(load_only<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb7-7" title="7"></a>
<a class="sourceLine" id="cb7-8" title="8">member <span class="op">=</span> Member.get_one(last_name<span class="op">=</span><span class="st">&#39;Venkman&#39;</span>)</a>
<a class="sourceLine" id="cb7-9" title="9"></a>
<a class="sourceLine" id="cb7-10" title="10">MemberSchema().dump(member)</a>
<a class="sourceLine" id="cb7-11" title="11"><span class="co"># {&#39;first_name&#39;: &#39;Peter&#39;, &#39;last_name&#39;: &#39;Venkman&#39;, &#39;birthdate&#39;: &#39;1960-09-06T00:00:00&#39;, &#39;age&#39;: 59}</span></a></code></pre></div>
</section><section id="sélection-dynamique-de-champs" class="slide level2">
<h2>Sélection dynamique de champs</h2>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb8-2" title="2">    first_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb8-3" title="3">    last_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb8-4" title="4">    birthdate <span class="op">=</span> ma.fields.DateTime()</a>
<a class="sourceLine" id="cb8-5" title="5"></a>
<a class="sourceLine" id="cb8-6" title="6">MemberSchema(only<span class="op">=</span>(<span class="st">&quot;last_name&quot;</span>, )).dump(member)</a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co"># {&#39;last_name&#39;: &#39;Venkman&#39;}</span></a>
<a class="sourceLine" id="cb8-8" title="8"></a>
<a class="sourceLine" id="cb8-9" title="9">MemberSchema(exclude<span class="op">=</span>(<span class="st">&quot;last_name&quot;</span>, )).dump(member)</a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co"># {&#39;first_name&#39;: &#39;Peter&#39;, &#39;birthdate&#39;: dt.datetime(1960, 9, 6)}</span></a></code></pre></div>
</section><section id="découplage-des-noms-de-champs-entre-modèle-et-api" class="slide level2">
<h2>Découplage des noms de champs entre modèle et API</h2>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb9-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb9-2" title="2">    first_name <span class="op">=</span> ma.fields.String(data_key<span class="op">=</span><span class="st">&quot;firstName&quot;</span>)</a>
<a class="sourceLine" id="cb9-3" title="3">    last_name <span class="op">=</span> ma.fields.String(data_key<span class="op">=</span><span class="st">&quot;lastName&quot;</span>)</a>
<a class="sourceLine" id="cb9-4" title="4">    birthdate <span class="op">=</span> ma.fields.DateTime(data_key<span class="op">=</span><span class="st">&quot;birth-date&quot;</span>)</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6">MemberSchema().dump(member)</a>
<a class="sourceLine" id="cb9-7" title="7"><span class="co"># {&#39;firstName&#39;: &#39;Peter&#39;, &#39;lastName&#39;: &#39;Venkman&#39;, &#39;birth-date&#39;: &#39;1960-09-06T00:00:00&#39;}</span></a></code></pre></div>
</section><section id="collections" class="slide level2">
<h2>Collections</h2>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb10-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb10-2" title="2">    first_name <span class="op">=</span> ma.fields.String(data_key<span class="op">=</span><span class="st">&quot;firstName&quot;</span>)</a>
<a class="sourceLine" id="cb10-3" title="3">    last_name <span class="op">=</span> ma.fields.String(data_key<span class="op">=</span><span class="st">&quot;lastName&quot;</span>)</a>
<a class="sourceLine" id="cb10-4" title="4"></a>
<a class="sourceLine" id="cb10-5" title="5">members <span class="op">=</span> Member.get_all()</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7">schema <span class="op">=</span> MemberSchema(many<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb10-8" title="8"></a>
<a class="sourceLine" id="cb10-9" title="9">schema.dump(members)</a>
<a class="sourceLine" id="cb10-10" title="10"><span class="co"># [</span></a>
<a class="sourceLine" id="cb10-11" title="11"><span class="co">#     {&#39;first_name&#39;: &#39;Egon&#39;, &#39;last_name&#39;: &#39;Spengler&#39;,},</span></a>
<a class="sourceLine" id="cb10-12" title="12"><span class="co">#     {&#39;first_name&#39;: &#39;Peter&#39;, &#39;last_name&#39;: &#39;Venkman&#39;,},</span></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="co"># ]</span></a></code></pre></div>
</section><section id="champs-imbriqués" class="slide level2">
<h2>Champs imbriqués</h2>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb11-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb11-2" title="2">    first_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb11-3" title="3">    last_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb11-4" title="4">    birthdate <span class="op">=</span> ma.fields.DateTime()</a>
<a class="sourceLine" id="cb11-5" title="5"></a>
<a class="sourceLine" id="cb11-6" title="6"><span class="kw">class</span> TeamSchema(ma.Schema):</a>
<a class="sourceLine" id="cb11-7" title="7">    name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb11-8" title="8">    members <span class="op">=</span> ma.fields.List(ma.fields.Nested(MemberSchema))</a>
<a class="sourceLine" id="cb11-9" title="9"></a>
<a class="sourceLine" id="cb11-10" title="10">team <span class="op">=</span> Team.get_one(name<span class="op">=</span><span class="st">&quot;Ghostbusters&quot;</span>)</a>
<a class="sourceLine" id="cb11-11" title="11"></a>
<a class="sourceLine" id="cb11-12" title="12">TeamSchema().dumps(team)</a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co"># {&#39;name&#39;: &#39;Ghostbusters&#39;,</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co">#  &#39;members&#39;: [</span></a>
<a class="sourceLine" id="cb11-15" title="15"><span class="co">#   {&#39;first_name&#39;: &#39;Egon&#39;, &#39;last_name&#39;: &#39;Spengler&#39;, &#39;birthdate&#39;: &#39;1958-10-02T00:00:00&#39;},</span></a>
<a class="sourceLine" id="cb11-16" title="16"><span class="co">#   {&#39;first_name&#39;: &#39;Peter&#39;, &#39;last_name&#39;: &#39;Venkman&#39;, &#39;birthdate&#39;: &#39;1960-09-06T00:00:00&#39;}</span></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="co"># ]}</span></a></code></pre></div>
</section><section id="pré-post-traitements" class="slide level2">
<h2>Pré-post traitements</h2>
<p><code>pre_load</code> / <code>post_load</code> / <code>pre_dump</code> / <code>post_dump</code></p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb12-2" title="2">    first_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb12-3" title="3">    last_name <span class="op">=</span> ma.fields.String()</a>
<a class="sourceLine" id="cb12-4" title="4">    birthdate <span class="op">=</span> ma.fields.DateTime()</a>
<a class="sourceLine" id="cb12-5" title="5"></a>
<a class="sourceLine" id="cb12-6" title="6">    <span class="at">@ma.post_load</span></a>
<a class="sourceLine" id="cb12-7" title="7">    <span class="kw">def</span> make_instance(<span class="va">self</span>, data, <span class="op">**</span>kwargs):</a>
<a class="sourceLine" id="cb12-8" title="8">        <span class="cf">return</span> Member(<span class="op">**</span>data)</a>
<a class="sourceLine" id="cb12-9" title="9"></a>
<a class="sourceLine" id="cb12-10" title="10">    member <span class="op">=</span> MemberSchema().load(</a>
<a class="sourceLine" id="cb12-11" title="11">        {<span class="st">&quot;first_name&quot;</span>: <span class="st">&quot;Peter&quot;</span>, <span class="st">&quot;last_name&quot;</span>: <span class="st">&quot;Venkman&quot;</span>, <span class="st">&quot;birthdate&quot;</span>: dt.datetime(<span class="dv">1960</span>, <span class="dv">9</span>, <span class="dv">6</span>)}</a>
<a class="sourceLine" id="cb12-12" title="12">    )</a>
<a class="sourceLine" id="cb12-13" title="13">    member.first_name</a>
<a class="sourceLine" id="cb12-14" title="14">    <span class="co"># &#39;Peter&#39;</span></a></code></pre></div>
</section><section id="validation-1" class="slide level2">
<h2>Validation (1)</h2>
<p>Validation à la désérialisation</p>
<ul>
<li>Champs obligatoires</li>
<li>Validation des valeurs</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb13-1" title="1"><span class="kw">class</span> MemberSchema(ma.Schema):</a>
<a class="sourceLine" id="cb13-2" title="2">    first_name <span class="op">=</span> ma.fields.String(validate<span class="op">=</span>ma.validate.Length(<span class="bu">min</span><span class="op">=</span><span class="dv">2</span>, <span class="bu">max</span><span class="op">=</span><span class="dv">50</span>))</a>
<a class="sourceLine" id="cb13-3" title="3">    last_name <span class="op">=</span> ma.fields.String(required<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb13-4" title="4">    birthdate <span class="op">=</span> ma.fields.DateTime()</a></code></pre></div>
</section><section id="validation-2" class="slide level2">
<h2>Validation (2)</h2>
<p>Structuration des messages d’erreur</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb14-1" title="1">MemberSchema().load({<span class="st">&quot;first_name&quot;</span>: <span class="st">&quot;V&quot;</span>})</a>
<a class="sourceLine" id="cb14-2" title="2"><span class="co"># marshmallow.exceptions.ValidationError: {</span></a>
<a class="sourceLine" id="cb14-3" title="3"><span class="co">#     &#39;last_name&#39;: [&#39;Missing data for required field.&#39;],</span></a>
<a class="sourceLine" id="cb14-4" title="4"><span class="co">#     &#39;first_name&#39;: [&#39;Length must be between 2 and 50.&#39;]</span></a>
<a class="sourceLine" id="cb14-5" title="5"><span class="co"># }</span></a></code></pre></div>
</section><section id="questions" class="slide level2">
<h2>Questions</h2>
</section></section>
<section><section id="intégration-orm-odm" class="title-slide slide level1"><h1>Intégration ORM / ODM</h1></section><section id="intégration-avec-différents-ormodm" class="slide level2">
<h2>Intégration avec différents ORM/ODM</h2>
<ul>
<li>ORM : <em>Object-Relation Mapping</em></li>
<li><p>ODM : <em>Object-Document Mapping</em></p></li>
<li>Intégration
<ul>
<li>Génération automatique de schémas marshmallow depuis le modèle</li>
<li>Types et validateurs inférés des classes du modèle</li>
<li>Permet de générer des schémas d’API en minimisant la duplication de code</li>
</ul></li>
<li>Exemples
<ul>
<li>SQLAlchemy → marshmallow-sqlalchemy</li>
<li>peewee → marshmallow-peewee</li>
<li>MongoEngine → marshmallow-mongoengine</li>
</ul></li>
</ul>
</section><section id="marshmallow-mongoengine" class="slide level2">
<h2>marshmallow-mongoengine</h2>
<h3 id="modèle">Modèle</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb15-1" title="1"><span class="im">import</span> mongoengine <span class="im">as</span> me</a>
<a class="sourceLine" id="cb15-2" title="2"></a>
<a class="sourceLine" id="cb15-3" title="3"><span class="kw">class</span> Team(me.Document):</a>
<a class="sourceLine" id="cb15-4" title="4">    name <span class="op">=</span> me.StringField(max_length<span class="op">=</span><span class="dv">40</span>)</a>
<a class="sourceLine" id="cb15-5" title="5">    members <span class="op">=</span> me.ListField(me.ReferenceField(<span class="st">&quot;Member&quot;</span>))</a>
<a class="sourceLine" id="cb15-6" title="6"></a>
<a class="sourceLine" id="cb15-7" title="7"><span class="kw">class</span> Member(me.Document):</a>
<a class="sourceLine" id="cb15-8" title="8">    first_name <span class="op">=</span> me.StringField()</a>
<a class="sourceLine" id="cb15-9" title="9">    last_name <span class="op">=</span> me.StringField()</a>
<a class="sourceLine" id="cb15-10" title="10">    birthdate <span class="op">=</span> me.DateTimeField()</a></code></pre></div>
</section><section class="slide level2">

<h3 id="schémas">Schémas</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb16-1" title="1"><span class="im">from</span> marshmallow_mongoengine <span class="im">import</span> ModelSchema</a>
<a class="sourceLine" id="cb16-2" title="2"></a>
<a class="sourceLine" id="cb16-3" title="3"><span class="kw">class</span> TeamSchema(ModelSchema):</a>
<a class="sourceLine" id="cb16-4" title="4">    <span class="kw">class</span> Meta:</a>
<a class="sourceLine" id="cb16-5" title="5">        model <span class="op">=</span> Team</a>
<a class="sourceLine" id="cb16-6" title="6"></a>
<a class="sourceLine" id="cb16-7" title="7"><span class="kw">class</span> MemberSchema(ModelSchema):</a>
<a class="sourceLine" id="cb16-8" title="8">    <span class="kw">class</span> Meta:</a>
<a class="sourceLine" id="cb16-9" title="9">        model <span class="op">=</span> Member</a>
<a class="sourceLine" id="cb16-10" title="10"></a>
<a class="sourceLine" id="cb16-11" title="11">team <span class="op">=</span> Team.objects.get(name<span class="op">=</span><span class="st">&quot;Ghostbusters&quot;</span>)</a>
<a class="sourceLine" id="cb16-12" title="12"></a>
<a class="sourceLine" id="cb16-13" title="13">TeamSchema().dump(team)</a>
<a class="sourceLine" id="cb16-14" title="14"><span class="co"># {&#39;id&#39;: 1,</span></a>
<a class="sourceLine" id="cb16-15" title="15"><span class="co">#   &#39;name&#39;: &#39;Ghostbusters&#39;,</span></a>
<a class="sourceLine" id="cb16-16" title="16"><span class="co">#  &#39;members&#39;: [</span></a>
<a class="sourceLine" id="cb16-17" title="17"><span class="co">#   {&#39;first_name&#39;: &#39;Egon&#39;, &#39;last_name&#39;: &#39;Spengler&#39;, &#39;birthdate&#39;: &#39;1958-10-02T00:00:00&#39;},</span></a>
<a class="sourceLine" id="cb16-18" title="18"><span class="co">#   {&#39;first_name&#39;: &#39;Peter&#39;, &#39;last_name&#39;: &#39;Venkman&#39;, &#39;birthdate&#39;: &#39;1960-09-06T00:00:00&#39;}</span></a>
<a class="sourceLine" id="cb16-19" title="19"><span class="co"># ]}</span></a>
<a class="sourceLine" id="cb16-20" title="20"></a>
<a class="sourceLine" id="cb16-21" title="21">TeamSchema().load({<span class="st">&quot;name&quot;</span>: <span class="st">&quot;This name is too long to pass validation.&quot;</span>})</a>
<a class="sourceLine" id="cb16-22" title="22"><span class="co"># marshmallow.exceptions.ValidationError: {&#39;name&#39;: [&#39;Longer than maximum length 40.&#39;]}</span></a></code></pre></div>
</section><section id="umongo-odm-mongodb" class="slide level2">
<h2>umongo : ODM MongoDB</h2>
<ul>
<li>Alternative à MongoEngine + marshmallow-mongoengine</li>
<li>Utilise marshmallow pour sérialization/désérialisation MongoDB BSON</li>
<li>Génère schemas marshmallow pour API</li>
<li>Fonctionne avec PyMongo, TxMongo, Motor</li>
</ul>
</section></section>
<section><section id="webargs" class="title-slide slide level1"><h1>webargs</h1></section><section id="webargs-désérialisation-de-requêtes" class="slide level2">
<h2>webargs : désérialisation de requêtes</h2>
<p>Désérialise et valide les requêtes HTTP</p>
<p>Prend en charge nativement les principaux serveurs web :</p>
<p>Flask, Django, Bottle, Tornado, Pyramid, webapp2, Falcon, aiohttp</p>
</section><section id="sans-webargs" class="slide level2">
<h2>Sans webargs</h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb17-1" title="1"><span class="im">from</span> flask <span class="im">import</span> Flask, request</a>
<a class="sourceLine" id="cb17-2" title="2"></a>
<a class="sourceLine" id="cb17-3" title="3">app <span class="op">=</span> Flask(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb17-4" title="4"></a>
<a class="sourceLine" id="cb17-5" title="5">team <span class="op">=</span> TeamSchema()</a>
<a class="sourceLine" id="cb17-6" title="6"></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="at">@app.route</span>(<span class="st">&quot;/teams/&quot;</span>, methods<span class="op">=</span>[<span class="st">&#39;POST&#39;</span>])</a>
<a class="sourceLine" id="cb17-8" title="8"><span class="kw">def</span> post():</a>
<a class="sourceLine" id="cb17-9" title="9">    <span class="co"># Désérialisation et validation</span></a>
<a class="sourceLine" id="cb17-10" title="10">    <span class="cf">try</span>:</a>
<a class="sourceLine" id="cb17-11" title="11">        team_data <span class="op">=</span> team_schema.load(request.json)</a>
<a class="sourceLine" id="cb17-12" title="12">    <span class="cf">except</span> ValidationError <span class="im">as</span> exc:</a>
<a class="sourceLine" id="cb17-13" title="13">        abort(<span class="dv">422</span>)</a>
<a class="sourceLine" id="cb17-14" title="14">    <span class="co"># Traitement</span></a>
<a class="sourceLine" id="cb17-15" title="15">    team <span class="op">=</span> Team(<span class="op">**</span>team_data)</a>
<a class="sourceLine" id="cb17-16" title="16">    team.save()</a>
<a class="sourceLine" id="cb17-17" title="17">    <span class="cf">return</span> team_schema.dump(team), <span class="dv">201</span></a></code></pre></div>
</section><section id="avec-webargs-1" class="slide level2">
<h2>Avec webargs (1)</h2>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb18-1" title="1"><span class="im">from</span> flask <span class="im">import</span> Flask</a>
<a class="sourceLine" id="cb18-2" title="2"><span class="im">from</span> webargs.flaskparser <span class="im">import</span> use_args</a>
<a class="sourceLine" id="cb18-3" title="3"></a>
<a class="sourceLine" id="cb18-4" title="4">app <span class="op">=</span> Flask(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb18-5" title="5"></a>
<a class="sourceLine" id="cb18-6" title="6"><span class="at">@app.route</span>(<span class="st">&quot;/&quot;</span>, methods<span class="op">=</span>[<span class="st">&#39;POST&#39;</span>])</a>
<a class="sourceLine" id="cb18-7" title="7"><span class="at">@use_args</span>(TeamSchema, location<span class="op">=</span><span class="st">&quot;json&quot;</span>)</a>
<a class="sourceLine" id="cb18-8" title="8"><span class="kw">def</span> post(team_data):</a>
<a class="sourceLine" id="cb18-9" title="9">    team <span class="op">=</span> Team(<span class="op">**</span>team_data)</a>
<a class="sourceLine" id="cb18-10" title="10">    team.save()</a>
<a class="sourceLine" id="cb18-11" title="11">    <span class="cf">return</span> team_schema.dump(team), <span class="dv">201</span></a></code></pre></div>
</section><section id="avec-webargs-2" class="slide level2">
<h2>Avec webargs (2)</h2>
<p>Inclure les erreurs de validation dans la réponse</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb19-1" title="1"><span class="im">from</span> flask <span class="im">import</span> jsonify</a>
<a class="sourceLine" id="cb19-2" title="2"></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co"># Return validation errors as JSON</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="at">@app.errorhandler</span>(<span class="dv">422</span>)</a>
<a class="sourceLine" id="cb19-5" title="5"><span class="kw">def</span> handle_error(err):</a>
<a class="sourceLine" id="cb19-6" title="6">    messages <span class="op">=</span> err.data.get(<span class="st">&quot;messages&quot;</span>, [<span class="st">&quot;Invalid request.&quot;</span>])</a>
<a class="sourceLine" id="cb19-7" title="7">    <span class="cf">return</span> jsonify({<span class="st">&quot;errors&quot;</span>: messages}), err.code</a></code></pre></div>
</section></section>
<section><section id="apispec" class="title-slide slide level1"><h1>apispec</h1></section><section id="apispec-documentation-openapi-swagger" class="slide level2">
<h2>apispec : Documentation OpenAPI (Swagger)</h2>
<p>Génération de la documentation OpenAPI</p>
<p>Introspection des schémas marshmallow</p>
<p>Prise en charge de flask, bottle, tornado via apispec-webframeworks</p>
</section><section id="webargs-apispec-exemple" class="slide level2">
<h2>webargs + apispec : exemple</h2>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb20-1" title="1"><span class="im">from</span> flask <span class="im">import</span> Flask, request</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="im">from</span> marshmallow <span class="im">import</span> Schema, fields</a>
<a class="sourceLine" id="cb20-3" title="3"><span class="im">from</span> webargs.flaskparser <span class="im">import</span> use_args</a>
<a class="sourceLine" id="cb20-4" title="4"><span class="im">from</span> apispec <span class="im">import</span> APISpec</a>
<a class="sourceLine" id="cb20-5" title="5"><span class="im">from</span> apispec.ext.marshmallow <span class="im">import</span> MarshmallowPlugin</a>
<a class="sourceLine" id="cb20-6" title="6"><span class="im">from</span> apispec_webframeworks.flask <span class="im">import</span> FlaskPlugin</a>
<a class="sourceLine" id="cb20-7" title="7"></a>
<a class="sourceLine" id="cb20-8" title="8">spec <span class="op">=</span> APISpec(</a>
<a class="sourceLine" id="cb20-9" title="9">    title<span class="op">=</span><span class="st">&quot;Team manager&quot;</span>,</a>
<a class="sourceLine" id="cb20-10" title="10">    version<span class="op">=</span><span class="st">&quot;1.0.0&quot;</span>,</a>
<a class="sourceLine" id="cb20-11" title="11">    openapi_version<span class="op">=</span><span class="st">&quot;3.0.2&quot;</span>,</a>
<a class="sourceLine" id="cb20-12" title="12">    plugins<span class="op">=</span>[FlaskPlugin(), MarshmallowPlugin()],</a>
<a class="sourceLine" id="cb20-13" title="13">)</a>
<a class="sourceLine" id="cb20-14" title="14"></a>
<a class="sourceLine" id="cb20-15" title="15">app <span class="op">=</span> Flask(<span class="va">__name__</span>)</a>
<a class="sourceLine" id="cb20-16" title="16">spec.init_app(app)</a></code></pre></div>
</section><section class="slide level2">

<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb21-1" title="1"><span class="at">@app.route</span>(<span class="st">&quot;/teams/&quot;</span>, methods<span class="op">=</span>[<span class="st">&quot;POST&quot;</span>])</a>
<a class="sourceLine" id="cb21-2" title="2"><span class="at">@use_args</span>(TeamSchema, location<span class="op">=</span><span class="st">&quot;json&quot;</span>)</a>
<a class="sourceLine" id="cb21-3" title="3"><span class="kw">def</span> post_team():</a>
<a class="sourceLine" id="cb21-4" title="4">    <span class="co">&quot;&quot;&quot;Post team</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="co">    ---</span></a>
<a class="sourceLine" id="cb21-6" title="6"><span class="co">    post:</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="co">      description: Add a new team.</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="co">      requestBody:</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="co">        description: Team</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="co">        required: true</span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="co">        content:</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="co">          application/json:</span></a>
<a class="sourceLine" id="cb21-13" title="13"><span class="co">            schema: TeamSchema</span></a>
<a class="sourceLine" id="cb21-14" title="14"><span class="co">      responses:</span></a>
<a class="sourceLine" id="cb21-15" title="15"><span class="co">        200:</span></a>
<a class="sourceLine" id="cb21-16" title="16"><span class="co">          content:</span></a>
<a class="sourceLine" id="cb21-17" title="17"><span class="co">            application/json:</span></a>
<a class="sourceLine" id="cb21-18" title="18"><span class="co">              schema: TeamSchema</span></a>
<a class="sourceLine" id="cb21-19" title="19"><span class="co">    &quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb21-20" title="20">    team <span class="op">=</span> Team(<span class="op">**</span>team_data)</a>
<a class="sourceLine" id="cb21-21" title="21">    team.save()</a>
<a class="sourceLine" id="cb21-22" title="22">    <span class="cf">return</span> TeamSchema().dump(team), <span class="dv">201</span></a>
<a class="sourceLine" id="cb21-23" title="23"></a>
<a class="sourceLine" id="cb21-24" title="24">spec.path(view<span class="op">=</span>post_team)</a></code></pre></div>
</section><section id="webargs-apispec-limitations" class="slide level2">
<h2>webargs + apispec : limitations</h2>
<ul>
<li>Duplication : docstring YAML</li>
<li>Sérialisation manuelle</li>
</ul>
</section></section>
<section><section id="flask-smorest" class="title-slide slide level1"><h1>flask-smorest</h1></section><section id="fonctionnalités-1" class="slide level2">
<h2>Fonctionnalités</h2>
<ul>
<li>Sérialisation / désérialisation des entrées / sorties : webargs</li>
<li>Documentation OpenAPI automatique (ou presque) : apispec</li>
<li>Pagination</li>
<li>ETag</li>
</ul>
</section><section id="structuration-dune-ressource" class="slide level2">
<h2>Structuration d’une ressource</h2>
<ul>
<li><code>Blueprint</code> → ressource</li>
<li><code>MethodView</code> → GET, POST, PUT, DELETE</li>
</ul>
</section><section class="slide level2">

<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb22-1" title="1"><span class="at">@blp.route</span>(<span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb22-2" title="2"><span class="kw">class</span> Teams(MethodView):</a>
<a class="sourceLine" id="cb22-3" title="3"></a>
<a class="sourceLine" id="cb22-4" title="4">    <span class="at">@blp.arguments</span>(TeamQueryArgsSchema, location<span class="op">=</span><span class="st">&quot;query&quot;</span>)</a>
<a class="sourceLine" id="cb22-5" title="5">    <span class="at">@blp.response</span>(TeamSchema(many<span class="op">=</span><span class="va">True</span>))</a>
<a class="sourceLine" id="cb22-6" title="6">    <span class="kw">def</span> get(<span class="va">self</span>, args):</a>
<a class="sourceLine" id="cb22-7" title="7">        <span class="co">&quot;&quot;&quot;List teams&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb22-8" title="8">        <span class="cf">return</span> Team.query.filter_by(<span class="op">**</span>args)</a>
<a class="sourceLine" id="cb22-9" title="9"></a>
<a class="sourceLine" id="cb22-10" title="10">    <span class="at">@blp.arguments</span>(TeamSchema)</a>
<a class="sourceLine" id="cb22-11" title="11">    <span class="at">@blp.response</span>(TeamSchema, code<span class="op">=</span><span class="dv">201</span>)</a>
<a class="sourceLine" id="cb22-12" title="12">    <span class="kw">def</span> post(<span class="va">self</span>, new_item):</a>
<a class="sourceLine" id="cb22-13" title="13">        <span class="co">&quot;&quot;&quot;Add a new team&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb22-14" title="14">        item <span class="op">=</span> Team(<span class="op">**</span>new_item)</a>
<a class="sourceLine" id="cb22-15" title="15">        db.session.add(item)</a>
<a class="sourceLine" id="cb22-16" title="16">        db.session.commit()</a>
<a class="sourceLine" id="cb22-17" title="17">        <span class="cf">return</span> item</a></code></pre></div>
</section><section class="slide level2">

<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb23-1" title="1"></a>
<a class="sourceLine" id="cb23-2" title="2"><span class="at">@blp.route</span>(<span class="st">&quot;/&lt;uuid:item_id&gt;&quot;</span>)</a>
<a class="sourceLine" id="cb23-3" title="3"><span class="kw">class</span> TeamsById(MethodView):</a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5">    <span class="at">@blp.response</span>(TeamSchema)</a>
<a class="sourceLine" id="cb23-6" title="6">    <span class="kw">def</span> get(<span class="va">self</span>, item_id):</a>
<a class="sourceLine" id="cb23-7" title="7">        <span class="co">&quot;&quot;&quot;Get team by ID&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb23-8" title="8">        <span class="cf">return</span> Team.query.get_or_404(item_id)</a>
<a class="sourceLine" id="cb23-9" title="9"></a>
<a class="sourceLine" id="cb23-10" title="10">    <span class="at">@blp.arguments</span>(TeamSchema)</a>
<a class="sourceLine" id="cb23-11" title="11">    <span class="at">@blp.response</span>(TeamSchema)</a>
<a class="sourceLine" id="cb23-12" title="12">    <span class="kw">def</span> put(<span class="va">self</span>, new_item, item_id):</a>
<a class="sourceLine" id="cb23-13" title="13">        <span class="co">&quot;&quot;&quot;Update an existing team&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb23-14" title="14">        item <span class="op">=</span> Team.query.get_or_404(item_id)</a>
<a class="sourceLine" id="cb23-15" title="15">        TeamSchema().update(item, new_item)</a>
<a class="sourceLine" id="cb23-16" title="16">        db.session.add(item)</a>
<a class="sourceLine" id="cb23-17" title="17">        db.session.commit()</a>
<a class="sourceLine" id="cb23-18" title="18">        <span class="cf">return</span> item</a>
<a class="sourceLine" id="cb23-19" title="19"></a>
<a class="sourceLine" id="cb23-20" title="20">    <span class="at">@blp.response</span>(code<span class="op">=</span><span class="dv">204</span>)</a>
<a class="sourceLine" id="cb23-21" title="21">    <span class="kw">def</span> delete(<span class="va">self</span>, item_id):</a>
<a class="sourceLine" id="cb23-22" title="22">        <span class="co">&quot;&quot;&quot;Delete a team&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb23-23" title="23">        item <span class="op">=</span> Team.query.get_or_404(item_id)</a>
<a class="sourceLine" id="cb23-24" title="24">        db.session.delete(item)</a>
<a class="sourceLine" id="cb23-25" title="25">        db.session.commit()</a></code></pre></div>
</section><section id="pagination" class="slide level2">
<h2>Pagination</h2>
<ul>
<li>Pagination <code>a posteriori</code> des resources renvoyant une liste</li>
<li>Validation des paramètres d’entrée <code>page</code> et <code>page_size</code> (query args)</li>
<li>Éléments de pagination renvoyés dans un Header</li>
</ul>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb24-1" title="1">headers[<span class="st">&quot;X-Pagination&quot;</span>]</a>
<a class="sourceLine" id="cb24-2" title="2"><span class="co"># {</span></a>
<a class="sourceLine" id="cb24-3" title="3"><span class="co">#     &#39;total&#39;: 1000, &#39;total_pages&#39;: 200,</span></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co">#     &#39;page&#39;: 2, &#39;first_page&#39;: 1, &#39;last_page&#39;: 200,</span></a>
<a class="sourceLine" id="cb24-5" title="5"><span class="co">#     &#39;previous_page&#39;: 1, &#39;next_page&#39;: 3,</span></a>
<a class="sourceLine" id="cb24-6" title="6"><span class="co"># }</span></a></code></pre></div>
</section><section id="pagination-dun-curseur-de-base-de-donnée" class="slide level2">
<h2>Pagination d’un curseur de base de donnée</h2>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb25-1" title="1"><span class="im">from</span> flask_smorest <span class="im">import</span> Page</a>
<a class="sourceLine" id="cb25-2" title="2"></a>
<a class="sourceLine" id="cb25-3" title="3"><span class="kw">class</span> SQLCursorPage(Page):</a>
<a class="sourceLine" id="cb25-4" title="4">    <span class="at">@property</span></a>
<a class="sourceLine" id="cb25-5" title="5">    <span class="kw">def</span> item_count(<span class="va">self</span>):</a>
<a class="sourceLine" id="cb25-6" title="6">        <span class="cf">return</span> <span class="va">self</span>.collection.count()</a>
<a class="sourceLine" id="cb25-7" title="7"></a>
<a class="sourceLine" id="cb25-8" title="8"></a>
<a class="sourceLine" id="cb25-9" title="9"><span class="at">@blp.route</span>(<span class="st">&quot;/&quot;</span>)</a>
<a class="sourceLine" id="cb25-10" title="10"><span class="kw">class</span> Teams(MethodView):</a>
<a class="sourceLine" id="cb25-11" title="11"></a>
<a class="sourceLine" id="cb25-12" title="12">    <span class="at">@blp.arguments</span>(TeamQueryArgsSchema, location<span class="op">=</span><span class="st">&quot;query&quot;</span>)</a>
<a class="sourceLine" id="cb25-13" title="13">    <span class="at">@blp.response</span>(TeamSchema(many<span class="op">=</span><span class="va">True</span>))</a>
<a class="sourceLine" id="cb25-14" title="14">    <span class="at">@blp.paginate</span>(SQLCursorPage)</a>
<a class="sourceLine" id="cb25-15" title="15">    <span class="kw">def</span> get(<span class="va">self</span>, args):</a>
<a class="sourceLine" id="cb25-16" title="16">        <span class="co">&quot;&quot;&quot;List teams&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb25-17" title="17">        <span class="cf">return</span> Team.query.filter_by(<span class="op">**</span>args)</a></code></pre></div>
</section><section id="etag" class="slide level2">
<h2>ETag</h2>
<ul>
<li><p>Identifie une version spécifique d’une ressource</p></li>
<li>GET : Économie de bande passante
<ul>
<li><code>If-None-Match: &quot;686897696a7c876b7e&quot;</code></li>
<li>Optionnel dans la requête</li>
<li>Si ETag correspond (ressource non modifiée), <code>304 Not Modified</code></li>
</ul></li>
<li>PUT/DELETE : Empêche les mises à jour simultanées
<ul>
<li><code>If-Match: &quot;686897696a7c876b7e&quot;</code></li>
<li>Obligatoire dans la requête</li>
<li>Si ETag manquant dans la requête, <code>428 Precondition required</code></li>
<li>Si ETag ne correspond pas (ressource modifiée), <code>412 Precondition failed</code></li>
</ul></li>
</ul>
</section><section id="démo" class="slide level2">
<h2>Démo</h2>
</section></section>
<section><section id="communauté-feuille-de-route" class="title-slide slide level1"><h1>Communauté, feuille de route</h1></section><section id="cycle-de-publication-1" class="slide level2">
<h2>Cycle de publication (1)</h2>
<p>Actuellement, deux branches de marshmallow maintenues.</p>
<table>
<thead>
<tr class="header">
<th>Branche</th>
<th>Python</th>
<th>Date de publication</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2.x</td>
<td>2.7+, 3.4+</td>
<td>25 septembre 2015</td>
</tr>
<tr class="even">
<td>3.x</td>
<td>3.5+</td>
<td>18 août 2019</td>
</tr>
</tbody>
</table>
</section><section id="cycle-de-publication-2" class="slide level2">
<h2>Cycle de publication (2)</h2>
<p>marshmallow est utilisé dans beaucoup de bibliothèques et <em>frameworks</em>.</p>
<p>Versions majeures peu fréquentes, nombreux changements.</p>
<table>
<thead>
<tr class="header">
<th>Version</th>
<th>Date de publication</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1.0.0</td>
<td>16 novembre 2014</td>
</tr>
<tr class="even">
<td>2.0.0a1</td>
<td>25 avril 2015</td>
</tr>
<tr class="odd">
<td>2.0.0</td>
<td>25 septembre 2015</td>
</tr>
<tr class="even">
<td>3.0.0a1</td>
<td>26 février 2017</td>
</tr>
<tr class="odd">
<td>3.0.0</td>
<td>18 août 2019</td>
</tr>
</tbody>
</table>
<p>webargs, apispec : versions majeures plus fréquentes, changements limités.</p>
</section><section id="bonnes-pratiques" class="slide level2">
<h2>Bonnes pratiques</h2>
<ul>
<li>Intégration continue, pytest, flake8, black, mypy</li>
<li>Python 3 partout</li>
<li>Communauté inclusive</li>
</ul>
</section></section>
<section><section id="nos-projets" class="title-slide slide level1"><h1>Nos projets</h1></section><section id="nobatekinef4" class="slide level2">
<h2>Nobatek/INEF4</h2>
<p>Institut National pour la Transition Énergétique et Environnementale du Bâtiment</p>
</section><section id="proleps" class="slide level2">
<h2>Proleps</h2>
<p>Gestion énergétique de patrimoine immobilier</p>
<p>Planification de rénovation</p>
<ul>
<li>MongoDB / umongo</li>
<li>marshmallow 2</li>
<li>flask-smorest</li>
</ul>
<p>https://www.nobatek.inef4.com/produits/proleps/</p>
</section><section id="bemserver-hit2gap-eu-h2020" class="slide level2">
<h2>BEMServer (Hit2Gap EU H2020)</h2>
<p>BuildingEnergyManagement Server</p>
<p>Plateforme <em>open-source</em> de gestion énergétique du bâtiment</p>
<p>Trois bases de données</p>
<ul>
<li>Modèle ontologique du bâtiment
<ul>
<li>Ontologie ifcOWL étendue</li>
<li>Jena SPARQL, webservice</li>
<li>Lecture / écrite en BDD manuelle, pas d’ORM</li>
</ul></li>
<li>Séries temporelles (HDF5)
<ul>
<li>Écriture via Pandas</li>
<li>Contourne marshmallow dans l’API (performance)</li>
</ul></li>
<li>Evènements (SQLite)
<ul>
<li>SQLAlchemy</li>
</ul></li>
</ul>
<p>https://www.bemserver.org/</p>
</section><section id="sigopti" class="slide level2">
<h2>Sigopti</h2>
<p>Plugin <em>open-source</em> de QGis</p>
<p>Pré-étude de faisabilité de réseaux de chaleur</p>
<p>Calculs asynchrones sur serveur distant via API web</p>
<ul>
<li>Solver IPOPT</li>
<li>Pyomo</li>
<li>Celery</li>
<li>Redis</li>
<li>flask-smorest</li>
</ul>
</section><section id="nature4cities-eu-h2020" class="slide level2">
<h2>Nature4Cities (EU H2020)</h2>
<p>Plateforme de comparaison et d’évaluation de solutions fondées sur la nature</p>
<p>Indicateurs socio-économiques, environnementaux, urbanisme…</p>
<p>Calculs synchrones sur serveur distant via API web</p>
<p>https://www.nature4cities.eu/</p>
</section></section>
<section><section id="questions-1" class="title-slide slide level1"><h1>Questions</h1></section></section>
<section><section id="liens" class="title-slide slide level1"><h1>Liens</h1></section></section>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/lib/js/head.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Push each slide change to the browser history
        history: true,
        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: '100%',
        height: '100%',

        // Optional reveal.js plugins
        dependencies: [
          { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/plugin/zoom-js/zoom.js', async: true },
          { src: 'https://cdnjs.cloudflare.com/ajax/libs/reveal.js/3.8.0/plugin/notes/notes.js', async: true }
        ]
      });
    </script>
    </body>
</html>
